<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Proposal Name: `retryable_error`Start Date: 2022-04-12RFC PR: apache/incubator-opendal#247Tracking Issue: apache/incubator-opendal#248Summary"><title>opendal::docs::rfcs::rfc_0247_retryable_error - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../../static.files/rustdoc-ba5701c5741a7b69.css" id="mainThemeStyle"><div id="rustdoc-vars" data-root-path="../../../../" data-static-root-path="../../../../static.files/" data-current-crate="opendal" data-themes="" data-resource-suffix="" data-rustdoc-version="1.70.0 (90c541806 2023-05-31)" data-search-js="search-e077946657036a58.js" data-settings-js="settings-298e1ea74db45b39.js" data-settings-css="settings-7bfb4c59cc6bc502.css" data-theme-light-css="light-0f8c037637f9eb3e.css" data-theme-dark-css="dark-1097f8e92a01e3cf.css" data-theme-ayu-css="ayu-614652228113ac93.css" ></div><script src="../../../../static.files/storage-62ce34ea385b278a.js"></script><script defer src="../../../../static.files/main-f61008743c98d196.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../../../../static.files/light-0f8c037637f9eb3e.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../../../../static.files/dark-1097f8e92a01e3cf.css"><link rel="stylesheet" href="../../../../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../../../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../../../../opendal/index.html"><img class="rust-logo" src="../../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../../../../opendal/index.html"><img class="rust-logo" src="../../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2 class="location"><a href="#">Module rfc_0247_retryable_error</a></h2><div class="sidebar-elems"></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../../../index.html">opendal</a>::<wbr><a href="../../index.html">docs</a>::<wbr><a href="../index.html">rfcs</a>::<wbr><a class="mod" href="#">rfc_0247_retryable_error</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../../../../src/opendal/docs/rfcs/mod.rs.html#63">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><ul>
<li>Proposal Name: <code>retryable_error</code></li>
<li>Start Date: 2022-04-12</li>
<li>RFC PR: <a href="https://github.com/apache/incubator-opendal/pull/247">apache/incubator-opendal#247</a></li>
<li>Tracking Issue: <a href="https://github.com/apache/incubator-opendal/issues/248">apache/incubator-opendal#248</a></li>
</ul>
<h2 id="summary"><a href="#summary">Summary</a></h2>
<p>Treat <code>io::ErrorKind::Interrupt</code> as retryable error.</p>
<h2 id="motivation"><a href="#motivation">Motivation</a></h2>
<p>Supports retry make our users’ lives easier:</p>
<blockquote>
<p><a href="https://github.com/apache/incubator-opendal/issues/196">Feature request: Custom retries for the s3 backend</a></p>
<p>While the reading/writing from/to s3, AWS occasionally returns errors that could be retried (at least 5xx?). Currently, in the databend, this will fail the whole execution of the statement (which may have been running for an extended time).</p>
</blockquote>
<p>Most users may need this retry feature, like <code>decompress</code>. Implementing it in OpenDAL will make users no bother, no backoff logic.</p>
<h2 id="guide-level-explanation"><a href="#guide-level-explanation">Guide-level explanation</a></h2>
<p>With the <code>retry</code> feature enabled:</p>
<div class="example-wrap"><pre class="language-toml"><code>opendal = {version=&quot;0.5.2&quot;, features=[&quot;retry&quot;]}
</code></pre></div>
<p>Users can configure the retry behavior easily:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">let </span>backoff = ExponentialBackoff::default();
<span class="kw">let </span>op = op.with_backoff(backoff);</code></pre></div>
<p>All requests sent by <code>op</code> will be automatically retried.</p>
<h2 id="reference-level-explanation"><a href="#reference-level-explanation">Reference-level explanation</a></h2>
<p>We will implement retry features via adding a new <code>Layer</code>.</p>
<p>In the retry layer, we will support retrying all operations. To do our best to keep retrying read &amp; write, we will implement <code>RetryableReader</code> and <code>RetryableWriter</code>, which will support retry while no actual IO happens.</p>
<h3 id="retry-operations"><a href="#retry-operations">Retry operations</a></h3>
<p>Most operations are safe to retry, like <code>list</code>, <code>stat</code>, <code>delete</code> and <code>create</code>.</p>
<p>We will retry those operations via input backoff.</p>
<h3 id="retry-io-operations"><a href="#retry-io-operations">Retry IO operations</a></h3>
<p>Retry IO operations are a bit complex because IO operations have side effects, especially for HTTP-based services like s3. We can’t resume an operation during the reading process without sending new requests.</p>
<p>This proposal will do the best we can: retry the operation if no actual IO happens.</p>
<p>If we meet an internal error before reading/writing the user’s buffer, it’s safe and cheap to retry it with precisely the same argument.</p>
<h3 id="retryable-error"><a href="#retryable-error">Retryable Error</a></h3>
<ul>
<li>Operator MAY retry <code>io::ErrorKind::Interrupt</code> errors.</li>
<li>Services SHOULD return <code>io::ErrorKind::Interrupt</code> kind if the error is retryable.</li>
</ul>
<h2 id="drawbacks"><a href="#drawbacks">Drawbacks</a></h2><h3 id="write-operation-cant-be-retried"><a href="#write-operation-cant-be-retried">Write operation can’t be retried</a></h3>
<p>As we return <code>Writer</code> to users, there is no way for OpenDAL to get the input data again.</p>
<h2 id="rationale-and-alternatives"><a href="#rationale-and-alternatives">Rationale and alternatives</a></h2><h3 id="implement-retry-at-operator-level"><a href="#implement-retry-at-operator-level">Implement retry at operator level</a></h3>
<p>We need to implement retry logic for every operator function, and can’t address the same problem:</p>
<ul>
<li><code>Reader</code> / <code>Writer</code> can’t be retired.</li>
<li>Intrusive design that users cannot expand on their own</li>
</ul>
<h2 id="prior-art"><a href="#prior-art">Prior art</a></h2>
<p>None</p>
<h2 id="unresolved-questions"><a href="#unresolved-questions">Unresolved questions</a></h2>
<ul>
<li><code>read</code> and <code>write</code> can’t be retried during IO.</li>
</ul>
<h2 id="future-possibilities"><a href="#future-possibilities">Future possibilities</a></h2>
<p>None</p>
</div></details></section></div></main></body></html>